import{V as w,D as k,c as b,g as B,a as L,h as M,e as E,f as y}from"./VLayout-fc878ec6.js";import{L as e}from"./leaflet.draw-src-43f32a12.js";import{_ as V,l as I}from"./index-64449bee.js";import{f as U,s as v,g as P,b as R}from"./connectionManager-2eeae4e5.js";import{o as m,c as f,a as t,w as n,F as g,u as C,r as _,b as u,t as d,g as T,h as z,M as j,N,d as S}from"./index-31b0bcf3.js";import{V as q}from"./VMain-ca383553.js";import{V as p,a as h}from"./VRow-0c2986bd.js";import{V as D}from"./VSelect-418528d4.js";import"./VList-95d5b38a.js";import"./VTextField-977154ce.js";import"./VField-b8a35a97.js";import"./VOverlay-88475a82.js";import"./scopeId-b3b08e45.js";const c=""+new URL("chincheta-c1ac390f.png",import.meta.url).href;const A=a=>(j("data-v-72ac271d"),a=a(),N(),a),O=A(()=>S("h3",{style:{"margin-left":"15px"}},"Submarins Fora de l'Aigua",-1)),J=A(()=>S("div",{id:"mapaSelect",style:{height:"700px",width:"850px"}},null,-1)),Z=A(()=>S("h3",null,"Submarins Submergits",-1)),$={data(){return{drawer:!1,submarinoSeleccionado:null,dialogoSubmarinoVisible:!1,selectedArea:null,areas:[],submarinosAsignados:[],submarinosDisponibles:[],submarinos:[],mapa:null,mapaGlobal:null,areaEncontrada:null,areaEncontradaID:null,mapaInicializado:!1,mostrarColumnaDerecha:!1,seleccionSubmarinos:{},nombreLugarBusqueda:"",submarinosFueraDelAgua:[],submarinosSumergidos:[],rutinas:[],filtroTarea:null,tareasDisponibles:[],ubicacionesSubmarinos:{},socket:null,filtroAplicado:!1,areaSeleccionada:!1,tareaSeleccionada:!1,estadoAnteriorMapa:{area:null,tarea:null,submarinos:[]},tareaSeleccionadaAntes:null}},methods:{guardarEstadoActualMapa(){!this.estadoAnteriorMapa.area&&this.areaEncontrada&&(this.estadoAnteriorMapa.area=this.areaEncontrada,this.estadoAnteriorMapa.submarinos=[...this.submarinosAsignados]),!this.estadoAnteriorMapa.tarea&&this.tareaSeleccionada&&(this.estadoAnteriorMapa.tarea=this.filtroTarea)},mostrarUbicacionSubmarino(a){if(this.ubicacionesSubmarinos[a]&&this.ubicacionesSubmarinos[a].length>0&&(this.areaSeleccionada||this.tareaSeleccionada))if(this.submarinoSeleccionado===a)this.restaurarEstadoMapa(),this.submarinoSeleccionado=null,this.tareaSeleccionadaAntes!==null&&(this.filtroTarea=this.tareaSeleccionadaAntes,this.filtrarSubmarinosPorTarea(),this.tareaSeleccionadaAntes=null);else{this.tareaSeleccionadaAntes=this.filtroTarea,this.submarinoSeleccionado=a,this.guardarEstadoActualMapa();const s=this.ubicacionesSubmarinos[a],i=this.mapa||this.mapaGlobal;this.limpiarMapa(i);const o=e.polyline(s,{color:"#122C34"}).addTo(i);i.fitBounds(o.getBounds());const r=s[s.length-1],l=e.icon({iconUrl:c,iconSize:[51,60],iconAnchor:[25,50]});e.marker([parseFloat(r[0]),parseFloat(r[1])],{icon:l}).addTo(i)}},mostrarUbicacionSubmarinoSinFiltros(a){if(this.ubicacionesSubmarinos[a]&&this.ubicacionesSubmarinos[a].length>0){if(!this.areaSeleccionada&&!this.tareaSeleccionada)if(this.submarinoSeleccionado===a)this.limpiarMapaGlobal(),this.restaurarEstadoMapaSinFiltros(!0),this.submarinoSeleccionado=null;else{this.submarinoSeleccionado=a,this.guardarEstadoActualMapaSinFiltros();const s=this.ubicacionesSubmarinos[a],i=this.mapa||this.mapaGlobal;this.limpiarMapaSinFiltros(i);const o=e.polyline(s,{color:"#122C34"}).addTo(i);i.fitBounds(o.getBounds());const r=s[s.length-1],l=e.icon({iconUrl:c,iconSize:[51,60],iconAnchor:[25,50]});e.marker([parseFloat(r[0]),parseFloat(r[1])],{icon:l}).addTo(i)}}else alert("Aquest submarí no té una ubicació.")},guardarEstadoActualMapaSinFiltros(){!this.estadoAnteriorMapa.area&&this.areaEncontrada&&(this.estadoAnteriorMapa.area=this.areaEncontrada,this.estadoAnteriorMapa.submarinos=[...this.submarinosAsignados]),!this.estadoAnteriorMapa.tarea&&this.tareaSeleccionada&&(this.estadoAnteriorMapa.tarea=this.filtroTarea)},restaurarEstadoMapaSinFiltros(a=!1){const{area:s,tarea:i,submarinos:o}=this.estadoAnteriorMapa;a?(this.limpiarMapaGlobal(),this.initMapaGlobal()):(s&&(this.areaEncontrada=s,this.submarinosAsignados=o,this.cargarCoordenadasEnMapaGlobal()),i&&(this.filtroTarea=i,this.filtrarSubmarinosPorTarea())),this.estadoAnteriorMapa={area:null,tarea:null,submarinos:[]}},limpiarMapaSinFiltros(a){a&&a.eachLayer(s=>{(s instanceof e.Marker||s instanceof e.Polyline)&&a.removeLayer(s)})},limpiarMapaGlobal(){this.mapaGlobal?(this.mapaGlobal.eachLayer(a=>{a instanceof e.Polyline&&this.mapaGlobal.removeLayer(a)}),this.dibujarRutasSubmarinos()):(this.initMapaGlobal(),this.dibujarRutasSubmarinos())},restaurarEstadoMapa(){const{area:a,tarea:s,submarinos:i}=this.estadoAnteriorMapa;a&&(this.areaEncontrada=a,this.submarinosAsignados=i,this.cargarCoordenadasEnMapaSelect(a.coordenadas)),s&&(this.filtroTarea=s,this.filtrarSubmarinosPorTarea()),this.estadoAnteriorMapa={area:null,tarea:null,submarinos:[]}},limpiarMapa(a){a&&a.eachLayer(s=>{(s instanceof e.Marker||s instanceof e.Polyline)&&a.removeLayer(s)})},tareasDisponible(){this.rutinas&&this.rutinas.length>0?this.tareasDisponibles=this.rutinas.map(a=>a.nombre):(this.tareasDisponibles=[],console.log("No hay rutinas disponibles o no se ha seleccionado un área."))},filtrarSubmarinosPorTarea(){if(this.tareaSeleccionada)this.filtroAplicado=!1,this.submarinosAsignados=this.submarinos.filter(a=>a.id_area===this.areaEncontradaID),this.clasificarSubmarinosPorRutina(),this.limpiarMapaSelect(),this.cargarCoordenadasEnMapaSelect(this.areaEncontrada.coordenadas),this.tareaSeleccionada=!1,this.filtroTarea=null;else{const a=this.rutinas.find(s=>s.nombre===this.filtroTarea);a?(this.submarinosAsignados=this.submarinos.filter(s=>s.actividades&&s.actividades.includes(a.id)),this.clasificarSubmarinosPorRutina(),this.areaEncontrada&&this.areaEncontrada.coordenadas&&this.dibujarMapaPorTarea(this.areaEncontrada.coordenadas,this.submarinosAsignados),this.filtroAplicado=!0,this.tareaSeleccionada=!0):this.submarinosAsignados=[]}this.submarinosAsignados.forEach(a=>{const s=this.ubicacionesSubmarinos[a.id_sub];if(s&&s.length>0){const i=s[s.length-1],o=e.icon({iconUrl:c,iconSize:[51,60],iconAnchor:[25,50]}),r=this.mapa||this.mapaGlobal;e.marker([parseFloat(i[0]),parseFloat(i[1])],{icon:o}).addTo(r)}})},clasificarSubmarinosPorRutina(){this.submarinosFueraDelAgua=this.submarinosAsignados.filter(a=>!a.estadoMarino),this.submarinosSumergidos=this.submarinosAsignados.filter(a=>a.estadoMarino)},clasificarSubmarinos(){this.submarinosFueraDelAgua=this.submarinos.filter(a=>!a.estadoMarino).slice(),this.submarinosSumergidos=this.submarinos.filter(a=>a.estadoMarino).slice(),this.submarinosFueraDelAgua=[...this.submarinosFueraDelAgua],this.submarinosSumergidos=[...this.submarinosSumergidos]},actualizarSubmarinos(){if(!this.areaEncontrada){this.submarinosAsignados=[],this.submarinosDisponibles=[],this.submarinosFueraDelAgua=[],this.submarinosSumergidos=[];return}this.submarinosAsignados=this.submarinos.filter(a=>a.id_area===this.areaEncontradaID),this.submarinosFueraDelAgua=this.submarinosAsignados.filter(a=>!a.estadoMarino),this.submarinosSumergidos=this.submarinosAsignados.filter(a=>a.estadoMarino),this.submarinosDisponibles=this.submarinos.filter(a=>a.id_area!==this.areaEncontradaID)},async getAreas(){try{const s=C().getUserEmpresa;this.areas=await U(),this.areas=this.areas.filter(i=>i.idEmpresa===s)}catch(a){console.error("Error fetching areas:",a)}},async buscarArea(){if(this.areaSeleccionada){this.nombreLugarBusqueda="",this.areaSeleccionada=!1,this.submarinosAsignados=[],this.submarinosFueraDelAgua=[],this.submarinosSumergidos=[],this.submarinosDisponibles=[],this.limpiarMapaNoSelect(),this.destruitMapaSelect(),this.tareaSeleccionada=!1,this.filtroTarea=null;const a=this.mapa||this.mapaGlobal;this.limpiarMapa(a),this.limpiarMapaGlobal(),this.initMapaGlobal(),await this.getSubmarino(),this.clasificarSubmarinos(),this.dibujarRutasSubmarinos()}else{const a=this.areas.find(s=>s.nombreArea===this.nombreLugarBusqueda);a?(this.limpiarMapaGlobal(),this.areaEncontrada=a,this.areaEncontradaID=a._id,this.mostrarColumnaDerecha=!0,this.submarinos=[],this.submarinosAsignados=[],this.submarinosFueraDelAgua=[],this.submarinosSumergidos=[],this.submarinosDisponibles=[],await this.selectRutinas(),await this.getSubmarinoMongo(),await this.actualizarSubmarinos(),this.cargarCoordenadasEnMapaSelect(a.coordenadas),this.areaSeleccionada=!0,this.submarinosAsignados.forEach(s=>{const i=this.ubicacionesSubmarinos[s.id_sub];if(i&&i.length>0){const o=i[i.length-1],r=e.icon({iconUrl:c,iconSize:[51,60],iconAnchor:[25,50]}),l=this.mapa||this.mapaGlobal;e.marker([parseFloat(o[0]),parseFloat(o[1])],{icon:r}).addTo(l)}})):(this.areaEncontrada=null,this.areaEncontradaID=null,this.mostrarColumnaDerecha=!1,this.tareasDisponibles=[],this.limpiarMapaNoSelect(),this.limpiarMapaGlobal(),await this.getSubmarino(),this.clasificarSubmarinos(),this.dibujarRutasSubmarinos(),this.destruitMapaSelect(),this.areaSeleccionada=!1)}},async selectRutinas(){try{const a=await v(this.areaEncontradaID);this.rutinas=a.rutinas,this.tareasDisponible()}catch(a){console.error("Error fetching rutinas:",a),this.rutinas=[]}},async getSubmarino(){const s=C().getUserEmpresa;try{const i=await P(s);this.submarinos=i,this.clasificarSubmarinos(),this.dibujarRutasSubmarinos()}catch(i){console.error("Error fetching submarinos:",i)}},async getSubmarinoMongo(){if(!this.areaEncontradaID){console.error("No area ID found. Please select an area first.");return}try{const a=await R(this.areaEncontradaID);a&&Array.isArray(a.Submarino)?(this.submarinos=a.Submarino,this.clasificarSubmarinos()):(console.error("Expected an array but got:",typeof a.Submarino),this.submarinos=[])}catch(a){console.error("Error fetching submarinos from Mongo:",a),this.submarinos=[]}},initMapaSelect(){this.mapa=e.map("mapaSelect").setView([41.38879,2.15899],11),e.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}.png",{maxZoom:18}).addTo(this.mapa);const a=new e.FeatureGroup;this.mapa.addLayer(a),this.drawControl=new e.Control.Draw({edit:{featureGroup:a,edit:!1,remove:!1},draw:{polygon:!1,circle:!1,rectangle:!1,marker:!1,polyline:!1,circlemarker:!1}}),this.mapa.addControl(this.drawControl),this.mapa.on(e.Draw.Event.CREATED,s=>{const i=s.layer;a.addLayer(i)})},cargarCoordenadasEnMapaSelect(a){this.limpiarMapaSelect(),this.initMapaSelect(),this.drawControl.addTo(this.mapa),this.dibujarAreaEnMapa(a,this.submarinosAsignados),this.submarinosAsignados.forEach(s=>{const i=this.ubicacionesSubmarinos[s.id_sub];if(i&&i.length>0){const o=i[i.length-1],r=e.icon({iconUrl:c,iconSize:[51,60],iconAnchor:[25,50]});e.marker([parseFloat(o[0]),parseFloat(o[1])],{icon:r}).addTo(this.mapa)}})},dibujarAreaEnMapa(a,s){const i=e.geoJSON({type:"Feature",geometry:{type:"Polygon",coordinates:a}}).addTo(this.mapa);s.forEach(o=>{if(this.ubicacionesSubmarinos[o.id_sub]){let r=this.ubicacionesSubmarinos[o.id_sub],l=e.polyline(r,{color:"#122C34"}).addTo(this.mapa);this.mapa.fitBounds(l.getBounds())}}),this.mapa.fitBounds(i.getBounds()),this.submarinosAsignados.forEach(o=>{const r=this.ubicacionesSubmarinos[o.id_sub];if(r&&r.length>0){const l=r[r.length-1],F=e.icon({iconUrl:c,iconSize:[51,60],iconAnchor:[25,50]}),G=this.mapa||this.mapaGlobal;e.marker([parseFloat(l[0]),parseFloat(l[1])],{icon:F}).addTo(G)}})},dibujarMapaPorTarea(a,s){if(this.limpiarMapaSelect(),this.mapa||this.initMapaSelect(),a){const i=e.geoJSON({type:"Feature",geometry:{type:"Polygon",coordinates:a}}).addTo(this.mapa);this.mapa.fitBounds(i.getBounds())}s.forEach(i=>{if(this.ubicacionesSubmarinos[i.id_sub]){let o=this.ubicacionesSubmarinos[i.id_sub],r=e.polyline(o,{color:"#122C34"}).addTo(this.mapa);this.mapa.fitBounds(r.getBounds())}})},limpiarMapaSelect(){this.mapa&&(this.drawControl&&this.mapa.removeControl(this.drawControl),this.mapa.eachLayer(a=>{this.mapa.removeLayer(a)}),this.mapa.remove(),this.mapa=null)},limpiarMapaNoSelect(){this.mapa&&this.drawControl&&this.mapa.removeControl(this.drawControl)},destruitMapaSelect(){this.mapa&&(this.mapa.remove(),this.mapa=null,this.initMapaGlobal(),this.dibujarRutasSubmarinos())},dibujarRutasSubmarinos(){if(!this.mapaGlobal){console.error("El mapa global no está inicializado");return}let a=new e.LatLngBounds;const s=this.submarinos.filter(i=>this.ubicacionesSubmarinos.hasOwnProperty(i.id_sub));s.forEach(i=>{let o=this.ubicacionesSubmarinos[i.id_sub],r=e.polyline(o,{color:"#122C34"}).addTo(this.mapaGlobal);a.extend(r.getBounds())}),a.isValid()&&this.mapaGlobal.fitBounds(a,{padding:[50,50]}),s.forEach(i=>{const o=this.ubicacionesSubmarinos[i.id_sub];if(o&&o.length>0){const r=o[o.length-1],l=e.icon({iconUrl:c,iconSize:[51,60],iconAnchor:[25,50]});e.marker([parseFloat(r[0]),parseFloat(r[1])],{icon:l}).addTo(this.mapaGlobal)}}),this.addPinMarker()},initMapaGlobal(){this.mapaGlobal?console.log("El mapa global ya está inicializado."):(this.mapaGlobal=e.map("mapaSelect",{center:[41.38879,2.15899],zoom:10,maxZoom:19}),e.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}.png",{maxZoom:19}).addTo(this.mapaGlobal),this.mapaGlobal.whenReady(()=>{this.mapaGlobal.setZoom(13)}))},obtenerUltimaUbicacionSubmarino(){const a=this.submarinos.find(s=>this.ubicacionesSubmarinos[s.id_sub]&&this.ubicacionesSubmarinos[s.id_sub].length>0);if(a){const s=this.ubicacionesSubmarinos[a.id_sub],i=s[s.length-1];return[parseFloat(i[0]),parseFloat(i[1])]}else return null},addPinMarker(){const a=e.icon({iconUrl:c,iconSize:[51,60],iconAnchor:[25,50]}),s=this.obtenerUltimaUbicacionSubmarino();s?e.marker(s,{icon:a}).addTo(this.mapaGlobal):console.log("No se encontraron ubicaciones de submarinos.")},cargarCoordenadasEnMapaGlobal(){this.mapaGlobal?this.limpiarMapaGlobal(this.mapaGlobal):this.initMapaGlobal(),this.drawControl.addTo(this.mapaGlobal)},limpiarMapaGlobal(){this.mapaGlobal?(this.mapaGlobal.remove(),this.mapaGlobal=null):(this.initMapaGlobal(),this.dibujarRutasSubmarinos())}},computed:{submarinosAsignadosFiltrados(){return this.submarinosAsignados.filter(a=>a.id_area===this.areaEncontradaID)}},created(){console.log("CREADO"),this.socket=I("http://seashepherd.duckdns.org:3170/"),this.socket.on("SelectUbicacionSubmarinos",a=>{this.ubicacionesSubmarinos={},a.forEach(s=>{this.ubicacionesSubmarinos[s.idSub]||(this.ubicacionesSubmarinos[s.idSub]=[]),s.ubicacions.forEach(i=>{if(Array.isArray(i.coordenadas)&&i.coordenadas.length>=2){let o=i.coordenadas[0].lat,r=i.coordenadas[1].lon;this.ubicacionesSubmarinos[s.idSub].push([o,r])}})})})},mounted(){console.log("MONTADO"),this.initMapaGlobal(),this.getAreas(),this.getSubmarino()},updated(){console.log("UPDATED")}},H=Object.assign($,{__name:"ubicacion",setup(a){return(s,i)=>(m(),f(g,null,[t(k),t(w,{class:"rounded rounded-md",style:{"background-color":"#EFEFEF"}},{default:n(()=>[t(q,null,{default:n(()=>[t(p,{style:{margin:"25px"}},{default:n(()=>[t(h,{cols:"12",sm:"3"},{default:n(()=>[t(b,null,{default:n(()=>[t(B,{height:"60",style:{"background-color":"#224870",color:"white"}},{default:n(()=>[O]),_:1}),t(L,null,{default:n(()=>[t(p,null,{default:n(()=>[(m(!0),f(g,null,_(s.submarinosFueraDelAgua,o=>(m(),T(h,{key:o.id_sub,cols:"12"},{default:n(()=>[t(b,{onClick:r=>s.mostrarUbicacionSubmarino(o.id_sub)||s.mostrarUbicacionSubmarinoSinFiltros(o.id_sub),style:{"background-color":"#84ACCE",color:"white"}},{default:n(()=>[t(E,null,{default:n(()=>[u(d(o.nom_sub),1)]),_:2},1024),t(y,null,{default:n(()=>[u("Estat: "+d(o.estado_sub),1)]),_:2},1024)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})]),_:1}),t(h,{cols:"12",sm:"6"},{default:n(()=>[t(D,{modelValue:s.nombreLugarBusqueda,"onUpdate:modelValue":i[0]||(i[0]=o=>s.nombreLugarBusqueda=o),items:[...s.areas.map(o=>o.nombreArea)],label:"Seleccionar àrea",onChange:s.actualizarSubmarinos,disabled:s.areaSeleccionada,style:{color:"#224870"}},null,8,["modelValue","items","onChange","disabled"]),t(D,{modelValue:s.filtroTarea,"onUpdate:modelValue":i[1]||(i[1]=o=>s.filtroTarea=o),items:[...s.tareasDisponibles],label:"Filtrar per Tasca/Rutina",onChange:s.filtrarSubmarinosPorTarea,disabled:!s.areaSeleccionada||s.tareaSeleccionada,style:{color:"#224870"}},null,8,["modelValue","items","onChange","disabled"]),t(M,{onClick:s.buscarArea,disabled:!s.nombreLugarBusqueda,color:s.areaSeleccionada?"red":"#84ACCE",dark:""},{default:n(()=>[u(d(s.areaSeleccionada?"Netejar àrea":"Cerca"),1)]),_:1},8,["onClick","disabled","color"]),t(M,{style:{"margin-left":"15px"},onClick:s.filtrarSubmarinosPorTarea,disabled:!s.nombreLugarBusqueda||!s.filtroTarea||s.filtroTarea===null,color:s.tareaSeleccionada?"red":"#84ACCE"},{default:n(()=>[u(d(s.tareaSeleccionada?"Netejar filtre":"Filtrar per tasca"),1)]),_:1},8,["onClick","disabled","color"]),t(b,{style:{"margin-top":"20px"},class:"mx-auto slidecontainer","max-height":"700","max-width":"850"},{default:n(()=>[J]),_:1})]),_:1}),t(h,{cols:"12",sm:"3"},{default:n(()=>[t(p,null,{default:n(()=>[t(h,{class:"text-center"},{default:n(()=>[Z,t(p,null,{default:n(()=>[(m(!0),f(g,null,_(s.submarinosSumergidos,o=>(m(),T(h,{key:o.id_sub,cols:"12"},{default:n(()=>[t(b,{class:z({"estado-activo":!0})},{default:n(()=>[t(E,null,{default:n(()=>[u(d(o.nom_sub),1)]),_:2},1024),t(y,null,{default:n(()=>[u("Última ubicació: "+d(o.ruta),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})],64))}}),na=V(H,[["__scopeId","data-v-72ac271d"]]);export{na as default};
